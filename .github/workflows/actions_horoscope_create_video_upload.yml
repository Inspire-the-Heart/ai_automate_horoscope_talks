name: Horoscope Consumer

on:
  workflow_run:
    workflows: ["Horoscope Main Content"]
    types:
      - completed

permissions:
  actions: read
  contents: read

concurrency:
  group: vionix_pipeline_main
  cancel-in-progress: false

env:
  PYTHONUNBUFFERED: "1"
  CUBLAS_WORKSPACE_CONFIG: ":4096:8"

  GEMENI_KEY: ${{ secrets.GEMENI_KEY }}
  GEMENI_MODEL: ${{ secrets.GEMENI_MODEL }}
  LANGUAGE: ${{ secrets.LANGUAGE }}

  FB_VERSION: ${{ secrets.FB_VERSION }}
  FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
  FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}

  INSTA_PAGE_ID: ${{ secrets.INSTA_PAGE_ID }}
  INSTA_PAGE_TOKEN: ${{ secrets.INSTA_PAGE_TOKEN }}

  JSON_CLIENT_YT: ${{ secrets.JSON_CLIENT_YT }}
  JSON_OAUTH_YT: ${{ secrets.JSON_OAUTH_YT }}

  HF_TOKEN: ${{ secrets.HF_TOKEN }}
  VIONIX_GIST_ID: ${{ secrets.VIONIX_GIST_ID }}

  VIONIX_WHEEL_DIR: .vionix-wheel

jobs:
  run:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: ðŸš€ Build & Run Horoscope Video
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      # âœ… DOWNLOAD artifact from previous run
      - name: Download JSON artifact from producer
        uses: actions/download-artifact@v4
        with:
          name: horoscope-files
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show downloaded files
        run: |
          echo "Downloaded files:"
          ls -la
          ls -la horoscope_*.json

      - uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-py311-${{ hashFiles('**/requirements.txt') }}

      - name: Cache Vionix wheel
        uses: actions/cache@v5
        with:
          path: ${{ env.VIONIX_WHEEL_DIR }}
          key: vionix-${{ runner.os }}-py311-${{ secrets.RELEASE_TAG }}

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip build

      - name: Build Vionix wheel (if needed)
        env:
          GH_PAT: ${{ secrets.GH_TOKEN }}
        run: |
          mkdir -p $VIONIX_WHEEL_DIR
          if ! ls $VIONIX_WHEEL_DIR/*.whl 1>/dev/null 2>&1; then
            echo "ðŸ”¨ Building Vionix from commit ${{ secrets.RELEASE_TAG }}"
            pip wheel \
              git+https://x-access-token:${GH_PAT}@github.com/simplycodesmart/Vionix.git@${{ secrets.RELEASE_TAG }} \
              -w $VIONIX_WHEEL_DIR
          else
            echo "âœ… Using cached Vionix wheel"
          fi

      - name: Install dependencies
        run: |
          pip install $VIONIX_WHEEL_DIR/*.whl
          pip install -r requirements.txt --prefer-binary

      - name: Install FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3
        with:
          ffmpeg-version: "6.1.0"

      # -------------------------------------------------
      # Auth files
      # -------------------------------------------------
      - name: Create auth files
        run: |
          python - <<'EOF'
          import json, os
          json.dump(json.loads(os.environ["JSON_CLIENT_YT"]), open("client_secrets.json","w"))
          json.dump(json.loads(os.environ["JSON_OAUTH_YT"]), open("oauth.json","w"))
          print("âœ… Auth files created")
          EOF

      # âœ… RUN your python video file
      - name: Execute Video Pipeline
        run: |
          python -c "import Vionix; print('âœ… Vionix import OK')"
          python main_hrscp_video_create_upload.py

      - name: Upload generated videos
        uses: actions/upload-artifact@v4
        with:
          name: horoscope-videos
          path: |
            daily_horoscope_te.mp4
#            daily_horoscope_ta.mp4
#            daily_horoscope_kn.mp4
#            daily_horoscope_ml.mp4
#            daily_horoscope_bn.mp4
#            daily_horoscope_mr.mp4
#            daily_horoscope_hi.mp4
          retention-days: 1

      - name: Cleanup JSON files
        run: |
            rm -f horoscope_*.json
            ls -la

      - uses: geekyeggo/delete-artifact@v5
        with:
          name: horoscope-files
